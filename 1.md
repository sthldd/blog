### __本文所使用如下版本，也可查看官方教程[Docker初始化nodejs](https://nodejs.org/zh-cn/docs/guides/nodejs-docker-webapp/)__
技术|版本
--|:--:|
Docker|20.10.5
Centos|7
Node|12.16.1
Next|9.5.1
Typeorm|0.2.29
postgres|12.2
### 在你的项目中创建 ```Dockerfile```  并复制下面内容
```ruby
FROM node:12

# Create app directory
WORKDIR /usr/src/app

COPY package.json ./
COPY yarn.lock ./
RUN yarn install
COPY . .
EXPOSE 3000
CMD [ "yarn", "start" ]

```
### 在你的项目中创建 ```.dockerignore```  并复制下面内容
```css
node_modules
*.log
```
### 本地创建镜像
```
docker build -t <your username>/node-web-app .
```
### 本地运行镜像
```3000:3000```，第一个是操作系统的端口，第二个是 ```docker``` 镜像的端口，为了方便记忆可以写成一样的
```
docker run -p 3000:3000 -d <your username>/node-web-app
```
### 查看运行状态
__docker ps__ 查看镜像运行状态，如果docker ps中没有你的 __xxx/node-web-app__ ，可以用 __docker logs xxx__ 容器id或者容器names 来查看日志
![E61F5070-5CF7-457E-89A9-5434A07CCF92.png](https://sthl-1256208836.cos.ap-shanghai.myqcloud.com/1617708634308.png)
### 本地访问
如果你使用的是 __window__ 或者旧版 __docker__，那么你可以使用 __本地ip:3000__ 端口，如果是 __mac__ 就用 __localhost:3000__ 来访问
### 购买服务器
###  使用ssh登陆服务器
使用ssh登陆服务器是为了上传打包后的文件到服务器，可以使用``` scp /Users/apple/Desktop/blog/dist.zip root@你的服务器iP:/home/blog/app```
```js
ssh-copy-id root@你的服务器iP
```
### 服务器安装Docker
[可以查看这个同学](https://cloud.tencent.com/developer/article/1701451) 或者 [官方教程](https://docs.docker.com/engine/install/centos/)
### 上传你的服务器pub key到github,并使用git clone 拉取代码
在你的 __root服务器__ 执行命令
```js
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
cat ~/.ssh/id_rsa.pub
```
### 服务器Docker创建postgresql
在服务器创建数据库之前，你的项目在本地已经创建过了，需要修改的是放数据的路径,把数据库存放到```home/root/blog-data```下
```js
docker run -v --network=host home/root/blog-data:/var/lib/postgresql/data -p 5432:5432 -e POSTGRES_USER=blog -e POSTGRES_HOST_AUTH_METHOD=trust -d postgres:12.2
```
### 进入docker的postgresql镜像里创建数据库和表
```ruby
docker exec -it  <数据库镜像id> bash
CREATE DATABASE <数据库名字> ENCODING 'UTF8' LC_COLLATE 'en_US.utf8' LC_CTYPE 'en_US.utf8';
```
### 服务器下载node和yarn
```js
curl -sL https://rpm.nodesource.com/setup_10.x | sudo bash -
sudo yum install nodejs

curl --silent --location https://dl.yarnpkg.com/rpm/yarn.repo | sudo tee /etc/yum.repos.d/yarn.repo
sudo rpm --import https://dl.yarnpkg.com/rpm/pubkey.gpg
sudo yum install yarn
```
### 在项目里install and  build你的文件
```
yarn install
yarn dev //ts变成js
typeorm migration:run  //生成数据库的表
yarn build  //nextjs 生成.next文件
```
### 服务器构建并且运行镜像
```
docker build -t <your username>/node-web-app .
docker run --network=host -p 3000:3000 -d <your username>/node-web-app
```
### 云服务器安全策略添加3000端口或者使用宝塔面板
![image.png](https://sthl-1256208836.cos.ap-shanghai.myqcloud.com/1617712956844.png)
### 使用服务器公网ip:3000端口就可访问你的网站